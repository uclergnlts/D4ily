{{- range $cronjob, $config := .Values.cronJobs }}
{{- if $config.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "d4ily-backend.fullname" . }}-{{ $cronjob }}
  labels:
    {{- include "d4ily-backend.labels" . | nindent 4 }}
spec:
  schedule: {{ $config.schedule | quote }}
  concurrencyPolicy: {{ $config.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ $config.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ $config.failedJobsHistoryLimit }}
  backoffLimit: {{ $config.backoffLimit }}
  activeDeadlineSeconds: {{ $config.activeDeadlineSeconds }}
  jobTemplate:
    metadata:
      labels:
        {{- include "d4ily-backend.selectorLabels" . | nindent 8 }}
    spec:
      template:
        metadata:
          labels:
            {{- include "d4ily-backend.selectorLabels" . | nindent 12 }}
        spec:
          restartPolicy: OnFailure
          serviceAccountName: {{ include "d4ily-backend.serviceAccountName" . }}
          containers:
            - name: {{ $cronjob }}
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              command:
                - node
                - -e
                - "require('./src/cron/{{ $cronjob }}Cron').start{{ $cronjob | title }}();"
              env:
                - name: NODE_ENV
                  value: {{ .Values.env.NODE_ENV | quote }}
                - name: LOG_LEVEL
                  value: {{ .Values.env.LOG_LEVEL | quote }}
                - name: TURSO_DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: turso-database-url
                - name: TURSO_AUTH_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: turso-auth-token
                - name: UPSTASH_REDIS_REST_URL
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: upstash-redis-rest-url
                - name: UPSTASH_REDIS_REST_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: upstash-redis-rest-token
                - name: FIREBASE_PROJECT_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: firebase-project-id
                - name: FIREBASE_PRIVATE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: firebase-private-key
                - name: FIREBASE_CLIENT_EMAIL
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: firebase-client-email
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: openai-api-key
                - name: RESEND_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: resend-api-key
                - name: REVENUECAT_PUBLIC_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: revenuecat-public-api-key
                - name: REVENUECAT_SECRET_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: revenuecat-secret-api-key
                - name: REVENUECAT_WEBHOOK_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: revenuecat-webhook-secret
                - name: CLOUDINARY_CLOUD_NAME
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: cloudinary-cloud-name
                - name: CLOUDINARY_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: cloudinary-api-key
                - name: CLOUDINARY_API_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: cloudinary-api-secret
                - name: SENTRY_DSN
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: sentry-dsn
                - name: POSTHOG_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: posthog-api-key
                - name: POSTHOG_HOST
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "d4ily-backend.fullname" . }}-secrets
                      key: posthog-host
              resources:
                {{- toYaml $config.resources | nindent 16 }}
{{- end }}
{{- end }}
